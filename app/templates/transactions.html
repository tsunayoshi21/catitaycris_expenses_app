<!doctype html>
<html lang="es">
<head>
  <meta charset="utf-8" />
  <title>Transacciones</title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
  {% block head %}
  <link rel="stylesheet" href="https://cdn.datatables.net/1.13.8/css/dataTables.bootstrap5.min.css">
  {% endblock %}
</head>
<body class="bg-light">
{% block content %}
<nav class="navbar navbar-expand-lg navbar-dark bg-dark">
  <div class="container-fluid">
    <a class="navbar-brand" href="/">Finanzas</a>
    <div class="d-flex">
      <a href="/logout" class="btn btn-outline-light btn-sm">Salir</a>
    </div>
  </div>
</nav>
<div class="container py-4">
  <h1 class="h4 mb-3">Transacciones</h1>
  <div id="err" class="alert alert-danger d-none"></div>
  <table id="txTable" class="table table-striped" style="width:100%">
    <thead>
      <tr>
        <th>Fecha</th>
        <th>Monto</th>
        <th>Comercio</th>
        <th>Tipo</th>
        <th>Categoría</th>
        <th>Descripción</th>
      </tr>
    </thead>
    <tbody></tbody>
  </table>
</div>
{% endblock %}
{% block scripts %}
<script src="https://code.jquery.com/jquery-3.7.1.min.js"></script>
<script src="https://cdn.datatables.net/1.13.8/js/jquery.dataTables.min.js"></script>
<script src="https://cdn.datatables.net/1.13.8/js/dataTables.bootstrap5.min.js"></script>
<script>
let table;
async function fetchData(){
  try{
    const res = await fetch('/api/transactions');
    if(res.status === 401){ window.location = '/login'; return []; }
    if(!res.ok){ console.error('API error', res.status); showErr('Error cargando transacciones ('+res.status+').'); return []; }
    return await res.json();
  }catch(e){
    console.error(e);
    showErr('No se pudo conectar al servidor.');
    return [];
  }
}
function showErr(msg){
  const el = document.getElementById('err');
  el.textContent = msg; el.classList.remove('d-none');
}
function toRow(t){
  return [new Date(t.date).toLocaleString(), t.amount.toFixed(2), t.merchant||'', t.type||'', t.category||'', t.description||'', t.id];
}
async function saveChange(id, field, value){
  try{
    const res = await fetch('/api/update_transaction', {
      method:'POST', headers:{'Content-Type':'application/json'},
      body: JSON.stringify({id, [field]: value})
    });
    if(res.status === 401){ window.location = '/login'; return; }
    if(!res.ok){ showErr('No se pudo guardar el cambio.'); }
  }catch(e){ showErr('No se pudo guardar el cambio.'); }
}
async function init(){
  const data = await fetchData();
  const rows = data.map(toRow);
  table = $('#txTable').DataTable({
    data: rows,
    columns: [
      { title: 'Fecha' },
      { title: 'Monto' },
      { title: 'Comercio' },
      { title: 'Tipo' },
      { title: 'Categoría' },
      { title: 'Descripción' },
      { title: 'ID', visible:false }
    ]
  });
  // Inline editing for category & description
  $('#txTable tbody').on('dblclick','td', function(){
    const cell = table.cell(this);
    const idx = cell.index().column;
    if(idx !== 4 && idx !== 5) return; // only category & description
    const rowData = table.row(this).data();
    const id = rowData[6];
    const current = cell.data();
    const input = $('<input type="text" class="form-control form-control-sm"/>').val(current);
    $(this).empty().append(input);
    input.focus();
    input.on('blur keydown', async (e)=>{
      if(e.type==='blur' || e.key==='Enter'){
        const val = input.val();
        cell.data(val).draw();
        await saveChange(id, idx===4?'category':'description', val);
      }
    });
  });
}
init();
</script>
{% endblock %}
</body>
</html>
